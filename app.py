# -*- coding: utf-8 -*-
"""emma.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15YsDsyz4O2f8ZRb0WDs_4iQUYaPpnzvj
"""
import os
from flask import Flask, request, jsonify, render_template_string
import pandas as pd

app = Flask(__name__)

# Carregar a planilha Excel
file_path = 'teste 1.xlsx'  # Certifique-se de que o arquivo esteja na mesma pasta que o app.py
df = pd.read_excel(file_path)

# Fun√ß√µes adaptadas
def search_in_spreadsheet(term):
    results = df[df['Palavras chaves'].str.contains(term, case=False, na=False)]
    if not results.empty:
        return results['T√≠tulo do documento'].tolist()
    else:
        return []

def get_link_by_title(title):
    result = df[df['T√≠tulo do documento'] == title]
    if not result.empty:
        return result['Link Qualyteam'].values[0]
    else:
        return None

# Rotas Flask
@app.route('/', methods=['GET'])
def home():
    return render_template_string('''
        <html>
            <head>
                <title>Emaboot Chatbot</title>
            </head>
            <body>
                <h1>Emaboot Chatbot</h1>
                <form action="/chatbot" method="POST">
                    <label for="query">Digite o termo que voc√™ procura:</label>
                    <input type="text" id="query" name="query" required>
                    <button type="submit">Buscar</button>
                </form>
            </body>
        </html>
    ''')

@app.route('/chatbot', methods=['POST'])
def chatbot_interaction():
    term = request.form.get('query')
    results = search_in_spreadsheet(term)
    
    if results:
        response = "<h2>ü§ñ Emaboot: Documentos encontrados:</h2><ul>"
        for i, title in enumerate(results, 1):
            response += f"<li>{i}. {title}</li>"
        response += "</ul>"
    else:
        response = "ü§ñ Emaboot: Nenhum documento encontrado com essas palavras-chave."
    
    return render_template_string(f'''
        <html>
            <head>
                <title>Emaboot Chatbot</title>
            </head>
            <body>
                <h1>Emaboot Chatbot</h1>
                <p>{response}</p>
                <a href="/">Voltar</a>
            </body>
        </html>
    ''')

@app.route('/get_link', methods=['POST'])
def get_link():
    title = request.json.get("title")
    link = get_link_by_title(title)
    
    if link:
        return jsonify({"response": f"Aqui est√° o link para '{title}': {link}"})
    else:
        return jsonify({"response": "Link n√£o encontrado para o t√≠tulo selecionado."})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))

